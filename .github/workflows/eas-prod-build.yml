name: Production Build

on:
  workflow_dispatch:

jobs:
  build-android-production:
    name: Build Android Production
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Setup Repo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Restore Gradle Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Create .env file
        run: |
          touch .env
          echo "EXPO_PUBLIC_ENV=production" >> .env
          echo "EXPO_PUBLIC_OUTDRINKME_API_URL=${{ secrets.EXPO_PUBLIC_OUTDRINKME_API_URL }}" >> .env
          echo "EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY }}" >> .env
          echo "EXPO_PUBLIC_POSTHOG_API_KEY=${{ secrets.EXPO_PUBLIC_POSTHOG_API_KEY }}" >> .env
          echo "EXPO_PUBLIC_CLOUDINARY_CLOUD_NAME=${{ secrets.EXPO_PUBLIC_CLOUDINARY_CLOUD_NAME }}" >> .env
          echo "EXPO_PUBLIC_CLOUDINARY_UPLOAD_PRESET=${{ secrets.EXPO_PUBLIC_CLOUDINARY_UPLOAD_PRESET }}" >> .env
          echo "EXPO_PUBLIC_CLOUDINARY_VIDEO_UPLOAD_PRESET=${{ secrets.EXPO_PUBLIC_CLOUDINARY_VIDEO_UPLOAD_PRESET }}" >> .env
          
          # We add it to .env for consistency, but the 'env' block below is the real fix
          echo "EXPO_PUBLIC_MAPBOX_TOKEN_PUBLIC=${{ secrets.EXPO_PUBLIC_MAPBOX_TOKEN_PUBLIC }}" >> .env
          
          echo " .env created with Production secrets"

      # --- REQUIRED: INJECT SECRET INTO APP.JSON ---
      - name: Inject Mapbox Secret into app.json
        run: |
          sed -i 's/MAPBOX_SECRET_TOKEN_PLACEHOLDER/${{ secrets.EXPO_PUBLIC_MAPBOX_TOKEN_SECRET }}/g' app.json
          echo "Mapbox secret injected into app.json"
      # ---------------------------------------------

      - name: Setup Android Keystore
        run: |
          mkdir -p credentials/android
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > credentials/android/keystore.jks
          echo "Keystore created at credentials/android/keystore.jks"

      - name: Create credentials.json
        run: |
          cat > credentials.json << 'EOF'
          {
            "android": {
              "keystore": {
                "keystorePath": "credentials/android/keystore.jks",
                "keystorePassword": "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}",
                "keyAlias": "${{ secrets.ANDROID_KEY_ALIAS }}",
                "keyPassword": "${{ secrets.ANDROID_KEY_PASSWORD }}"
              }
            }
          }
          EOF
          echo "Credentials file created"

      - name: Build Android Production AAB
        run: eas build --platform android --profile production --local --clear-cache  --non-interactive --output=./app-release.aab
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"
          # ðŸ‘‡ THIS IS REQUIRED FOR PRODUCTION TOO
          EXPO_PUBLIC_MAPBOX_TOKEN_PUBLIC: ${{ secrets.EXPO_PUBLIC_MAPBOX_TOKEN_PUBLIC }}

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: android-production-build
          path: ./app-release.aab
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ./app-release.aab
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup credentials
        if: always()
        run: |
          rm -rf credentials
          rm -f credentials.json
          rm -f .env
          # Revert app.json to avoid leaving the secret key in the workspace if cached
          git checkout app.json 
          echo "Sensitive files cleaned up"

      - name: Build Summary
        if: success()
        run: |
          echo "### Production Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type:** AAB (Play Store)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Download the AAB from the artifacts section above." >> $GITHUB_STEP_SUMMARY